name: release-please

on:
  push:
    branches:
      - main        # â† ãƒ‡ãƒ•ã‚©ãƒ–ãƒ©ãƒ³ãƒã«åˆã‚ã›ã¦

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0      # ã‚¿ã‚°å–å¾—ã«å¿…é ˆ

      # â”€â”€ ãƒ‡ãƒãƒƒã‚°ï¼šãƒªãƒæ§‹é€ ã‚’å‡ºåŠ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ•µï¸ Show file tree
        run: |
          echo "PWD: $(pwd)"
          echo "===== ls -R ====="
          ls -R

      # â”€â”€ package.json ãŒæœ¬å½“ã«ã‚ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Sanity check
        run: |
          test -f Packages/src/package.json && echo "âœ… package.json OK"

      # package.jsonã‚’ãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆçµ¶å¯¾ãƒ‘ã‚¹ä½¿ç”¨ï¼‰
      - name: ğŸ“‹ Copy package.json to root
        run: |
          cp $GITHUB_WORKSPACE/Packages/src/package.json $GITHUB_WORKSPACE/
          cat package.json  # å†…å®¹ç¢ºèª
          echo "âœ… package.json copied to root"

      # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±
      - name: ğŸ” Verify package.json exists in root
        run: |
          echo "Current directory: $(pwd)"
          ls -la
          if [ -f "package.json" ]; then
            echo "âœ… package.json exists in root directory"
            echo "Content of package.json:"
            cat package.json | head -10
          else
            echo "âŒ package.json NOT found in root directory"
            find . -name "package.json" -type f
            exit 1
          fi

      # releaseã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆå¿µã®ãŸã‚ï¼‰
      - name: ğŸ“ Create release-please config
        run: |
          echo '{
            "packages": {
              ".": {
                "release-type": "node"
              }
            }
          }' > release-please-config.json
          echo "âœ… Created release-please-config.json"
          cat release-please-config.json

      # â”€â”€ releaseâ€‘please æœ¬ç•ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Run releaseâ€‘please
        uses: googleapis/release-please-action@v4
        with:
          release-type: node
          # pathãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆãƒ«ãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼‰
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
          config-file: release-please-config.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}